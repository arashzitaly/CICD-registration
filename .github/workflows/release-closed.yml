name: Release Close

on:
    pull_request:
        types: [closed]
        branches: [main]

permissions:
    contents: write
    pull-requests: write

jobs:
    finish-release:
        if: github.event.pull_request.merged == true && startsWith(github.head_ref, 'release/')
        runs-on: ubuntu-latest
        steps:
            - name: Checkout
              uses: actions/checkout@v4
              with:
                  fetch-depth: 0

            - name: Merge main back into develop
              run: |
                  git config user.name "github-actions[bot]"
                  git config user.email "github-actions[bot]@users.noreply.github.com"
                  git checkout develop
                  git pull origin develop
                  git merge --no-ff origin/main -m "Back-merge main into develop after release"
                  git push origin develop

            - name: Delete release branch
              uses: actions/github-script@v7
              with:
                  script: |
                      const ref = `heads/${context.payload.pull_request.head.ref}`;
                      await github.rest.git.deleteRef({
                        owner: context.repo.owner,
                        repo: context.repo.repo,
                        ref
                      });
